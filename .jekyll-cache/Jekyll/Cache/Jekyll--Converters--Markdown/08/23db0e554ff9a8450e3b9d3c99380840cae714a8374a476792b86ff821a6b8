I"&+<h2 id="data">Data</h2>
<p>In this post we will build and evaluate two bayesian models to predict the probability of a driver finishing in the top 5 of a given race. The data was scrapped from the FIA’s website, check out my post LINK HERE, for more information on webscrapping. The raw data was later transformed using another script which you can find in my github repo LINK HERE. Specifically the following modifications were made:</p>
<ol>
  <li>The Indy-500 race was dropped since most regular F1 drivers didn’t participated in it.</li>
  <li>Observations that had two drivers were separated into two rows, with all other variables equal. (If two drivers shared one car in a race and scored points, these were divided equally between them).</li>
  <li>Make sure a driver only appear once in a grand prix, if he had two or more entries the one with the most amount of laps was kept.</li>
  <li>Lap time, total race time, and best lap of the race were all character variables, which were transformed to total seconds.</li>
  <li>Race position contained “DNF” (Did Not Finish) indicators, which were set to 99, and missing values too.</li>
  <li>The engine variable was transformed to only display the manufacturer, leaving out model number and other additional information.</li>
  <li>Teams and engines were transformed to factor variable, those that didn’t appear more than 10 times in the whole dataset were set to “other”.</li>
  <li>Teams that only had one distinct driver in the whole dataset were set to “solo”.</li>
</ol>

<p>For these transformed version of our dataset had 828 rows with 141 different drivers, 17 teams and 13 different engine manufacturers. \</p>

<p>First we need to load the necessary libraries. We will use tidyverse for data manipulation and plotting. We will be running models using <a href="https://mc-stan.org/docs/stan-users-guide/index.html"><code class="language-plaintext highlighter-rouge">stan</code></a> and the <code class="language-plaintext highlighter-rouge">rstan</code> package. To analyze the results we will use the <a href="https://mjskay.github.io/tidybayes/"><code class="language-plaintext highlighter-rouge">tidybayes</code></a> library.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidybayes</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">viridis</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rstan</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>Before start fitting any models we need to load the data.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/abraham-mv/formula-1/main/data/data_for_model.csv"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">X</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>In Formula 1, the drivers’ ability isn’t the most important factor on where will they finish a race, the machinery underneeth them is. That being said let’s look at proportions of race positions by engine manufacturer.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_model</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
</span><span class="n">mutate</span><span class="p">(</span><span class="n">engine_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">engine_index</span><span class="p">),</span><span class="w">
         </span><span class="n">race_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">race_pos</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">99</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">race_pos</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">race_pos</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_engine</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
   </span><span class="n">geom_bar</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">..prop..</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Race position"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Proportions"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Race positions by engine manufacturer"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">22</span><span class="p">,</span><span class="m">2</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1.8</span><span class="p">,</span><span class="m">0.2</span><span class="p">))</span><span class="w"> 
</span></code></pre></div></div>
<p>We can see how dominant certain engine manufactures were in the early days of the sport, as the proportions of finishing first and second in the race were completely occupied by just four manufactures: Alfa Romeo, Ferrari, Maserati and Mercedes. Below we can see the distribution of</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data_model</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">Driver</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">appear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">filter</span><span class="p">(</span><span class="n">appear</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">Kph</span><span class="p">,</span><span class="w"> </span><span class="n">Driver</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Driver</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_boxplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"none"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scale_fill_viridis</span><span class="p">(</span><span class="n">discrete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="candidate-models">Candidate models</h2>
<p>Given that the outcome variable is binary, we will fit a Bayesian logistic regression model (fixed effects). Also, based on the EDA, it might be a good idea to model some variables hierarchically (i.e mixed effects model).
The first Bayesian logistic regression is described by the following equation:
\(\begin{aligned}
y_i | \theta_i &amp;\sim \text{Bernoulli}(\theta_i) \\
\text{logit}(\theta_i) &amp;= \beta_0 + \beta_1x_{\text{quali-pos}} + \beta_2x_{\text{avg-speed}} +  x^\top_{\text{engine}}\boldsymbol{\beta_3} + \beta_4x_{\text{champ-points}} \\
\beta_0,\dots,\beta_4&amp;\sim N(0,1)
\end{aligned}\)</p>

<p>For the mixed effects model, we will model the drivers, teams and engine manufacturers hierarchically.</p>

<p>\(\begin{aligned}
y_i | \theta_i &amp;\sim \text{Bernoulli}(\theta_i) \\
\text{logit}(\theta_i) &amp;= \alpha_0 + \alpha^{\text{driver}}_{d[i]}x_{\text{quali-pos}} + 
                          \alpha^{\text{team}}_{t[i]} + \alpha_{e[i]}^{\text{engine}}  \\
\alpha^{\text{driver}}_d &amp;\sim N(\mu_d^{\text{driver}}, \sigma_d^{\text{driver}}) \\
\alpha^{\text{team}}_t &amp;\sim N(\mu_t^{\text{team}}, \sigma_t^{\text{team}}) \\
\alpha^{\text{engine}}_e &amp;\sim N(\mu_e^{\text{engine}}, \sigma_e^{\text{engine}}) \\
\mu_d^{\text{driver}}&amp;\sim N(0,1)\\
\mu_d^{\text{team}}&amp;\sim N(0,1)\\
\mu_d^{\text{engine}}&amp;\sim N(0,1)\\
\sigma_d^{\text{driver}}&amp;\sim N^+(0,1)\\
\sigma_d^{\text{team}}&amp;\sim N^+(0,1)\\
\sigma_d^{\text{engine}}&amp;\sim N^+(0,1)\\
\alpha_0 &amp;\sim N(0,1) 
\end{aligned}\)</p>
<ul>
  <li>$y_i$: 1 if the driver at observation $i$ scored points, 0 otherwise.</li>
  <li>$x_{\text{quali-pos}}$: the position the driver qualified (started the race).</li>
  <li>$d[i]$: indicates who’s the driver in row $i$ of the dataset; $d\in{1,\dots,141}$</li>
  <li>$t[i]$: indicates the team the driver in row $i$ is driving for; $t\in{1,\dots,17}$</li>
  <li>$e[i]$: indicates the engine the team in row $i$ is using; $e\in{1,\dots,13}$
Here we have two variable intercept corresponding the team and engine, and a coefficient for the qualifying position which varies with the driver.</li>
</ul>

<h2 id="running-the-models">Running the models</h2>
<p>To run the models we will use <a href="https://mc-stan.org/docs/stan-users-guide/index.html"><code class="language-plaintext highlighter-rouge">stan</code></a>. Below is the code for the first one. Instead of specifying each feature individually, we can give stan a covariate matrix, and let it now that the beta coefficients are in vector format.</p>
<div class="language-stan highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">data</span> <span class="p">{</span>
  <span class="kt">int</span><span class="o">&lt;</span><span class="na">lower</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;</span> <span class="nv">N</span><span class="p">;</span> <span class="c1">// Number of observations</span>
  <span class="kt">int</span><span class="o">&lt;</span><span class="na">lower</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;</span> <span class="nv">K</span><span class="p">;</span> <span class="c1">// Number of features</span>
  <span class="kt">int</span><span class="o">&lt;</span><span class="na">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="na">upper</span><span class="o">=</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nv">y</span><span class="p">[</span><span class="nv">N</span><span class="p">];</span> <span class="c1">// Outcome variable</span>
  <span class="kt">matrix</span><span class="p">[</span><span class="nv">N</span><span class="p">,</span> <span class="nv">K</span><span class="p">]</span> <span class="nv">X</span><span class="p">;</span>
<span class="p">}</span>
<span class="nn">parameters</span> <span class="p">{</span>
  <span class="kt">vector</span><span class="p">[</span><span class="nv">K</span><span class="p">]</span> <span class="nv">beta</span><span class="p">;</span> <span class="c1">// Vector of coefficients</span>
<span class="p">}</span>
<span class="nn">transformed parameters</span><span class="p">{</span>
  <span class="kt">vector</span><span class="p">[</span><span class="nv">N</span><span class="p">]</span> <span class="nv">theta</span><span class="p">;</span>
  <span class="nv">theta</span> <span class="o">=</span> <span class="nv">X</span> <span class="o">*</span> <span class="nv">beta</span><span class="p">;</span> <span class="c1">// Specifying the theta parameter for the bernoulli dist.</span>
<span class="p">}</span>

<span class="nn">model</span> <span class="p">{</span>
  <span class="nv">beta</span> <span class="o">~</span> <span class="nb">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
  <span class="nv">y</span> <span class="o">~</span> <span class="nb">bernoulli_logit</span><span class="p">(</span><span class="nv">theta</span><span class="p">);</span> 
<span class="p">}</span>
<span class="nn">generated quantities</span> <span class="p">{</span>
  <span class="c1">// simulate data from the posterior</span>
  <span class="kt">vector</span><span class="p">[</span><span class="nv">N</span><span class="p">]</span> <span class="nv">y_rep</span><span class="p">;</span>
  <span class="c1">// log-likelihood posterior</span>
  <span class="kt">vector</span><span class="p">[</span><span class="nv">N</span><span class="p">]</span> <span class="nv">log_lik</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nv">i</span> <span class="kr">in</span> <span class="mi">1</span><span class="o">:</span><span class="nb">num_elements</span><span class="p">(</span><span class="nv">y_rep</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">y_rep</span><span class="p">[</span><span class="nv">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bernoulli_rng</span><span class="p">(</span><span class="nb">inv_logit</span><span class="p">(</span><span class="nv">theta</span><span class="p">[</span><span class="nv">i</span><span class="p">]));</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="nv">i</span> <span class="kr">in</span> <span class="mi">1</span><span class="o">:</span><span class="nb">num_elements</span><span class="p">(</span><span class="nv">log_lik</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">log_lik</span><span class="p">[</span><span class="nv">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bernoulli_logit_lpmf</span><span class="p">(</span><span class="nv">y</span><span class="p">[</span><span class="nv">i</span><span class="p">]</span> <span class="p">|</span> <span class="nv">theta</span><span class="p">[</span><span class="nv">i</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The second model is not a lot more complicated, we just need to feed stan with much more information, like number of drivers, teams and engines, and an id for all of those. It’s important to make sure that all standard deviations are bigger than zero!</p>
<div class="language-stan highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">data</span> <span class="p">{</span>
  <span class="kt">int</span><span class="o">&lt;</span><span class="na">lower</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;</span> <span class="nv">N</span><span class="p">;</span>  <span class="c1">// number of observations</span>
  <span class="kt">int</span><span class="o">&lt;</span><span class="na">lower</span><span class="o">=</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nv">D</span><span class="p">;</span>  <span class="c1">// number of drivers</span>
  <span class="kt">int</span><span class="o">&lt;</span><span class="na">lower</span><span class="o">=</span><span class="mi">1</span><span class="o">&gt;</span> <span class="kr">T</span><span class="p">;</span>  <span class="c1">// number of teams</span>
  <span class="kt">int</span><span class="o">&lt;</span><span class="na">lower</span><span class="o">=</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nv">E</span><span class="p">;</span>  <span class="c1">// number of engines</span>
  <span class="kt">int</span><span class="o">&lt;</span><span class="na">lower</span><span class="o">=</span><span class="mi">1</span><span class="o">&gt;</span> <span class="nv">Y</span><span class="p">;</span>  <span class="c1">// number of years</span>
  <span class="kt">int</span> <span class="nv">driver</span><span class="p">[</span><span class="nv">N</span><span class="p">];</span>    <span class="c1">// driver ID of each observation</span>
  <span class="kt">int</span> <span class="nv">team</span><span class="p">[</span><span class="nv">N</span><span class="p">];</span>      <span class="c1">// team ID of each observation</span>
  <span class="kt">int</span> <span class="nv">engine</span><span class="p">[</span><span class="nv">N</span><span class="p">];</span>    <span class="c1">// engine ID of each observation</span>
  <span class="kt">int</span> <span class="nv">grid</span><span class="p">[</span><span class="nv">N</span><span class="p">];</span>      <span class="c1">// starting grid position of each observation</span>
  <span class="kt">int</span> <span class="nv">finished</span><span class="p">[</span><span class="nv">N</span><span class="p">];</span>  <span class="c1">// binary outcome of each observation (0 = outside top 5, 1 = inside top 5)</span>
  <span class="kt">int</span> <span class="nv">num_races</span><span class="p">[</span><span class="nv">N</span><span class="p">];</span> <span class="c1">// number of races each driver participated in</span>
<span class="p">}</span>

<span class="nn">parameters</span> <span class="p">{</span>
  <span class="kt">real</span> <span class="nv">Intercept</span><span class="p">;</span>
  <span class="kt">vector</span><span class="p">[</span><span class="nv">D</span><span class="p">]</span> <span class="nv">driver_effect</span><span class="p">;</span>
  <span class="kt">vector</span><span class="p">[</span><span class="kr">T</span><span class="p">]</span> <span class="nv">team_effect</span><span class="p">;</span>
  <span class="kt">vector</span><span class="p">[</span><span class="nv">E</span><span class="p">]</span> <span class="nv">engine_effect</span><span class="p">;</span>
  <span class="kt">real</span> <span class="nv">driver_mu</span><span class="p">;</span>
  <span class="kt">real</span><span class="o">&lt;</span><span class="na">lower</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;</span> <span class="nv">driver_sd</span><span class="p">;</span>
  <span class="kt">real</span> <span class="nv">team_mu</span><span class="p">;</span>
  <span class="kt">real</span><span class="o">&lt;</span><span class="na">lower</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;</span> <span class="nv">team_sd</span><span class="p">;</span>
  <span class="kt">real</span> <span class="nv">engine_mu</span><span class="p">;</span>
  <span class="kt">real</span><span class="o">&lt;</span><span class="na">lower</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;</span> <span class="nv">engine_sd</span><span class="p">;</span>
<span class="p">}</span>

<span class="nn">transformed parameters</span><span class="p">{</span>
  <span class="kt">vector</span><span class="p">[</span><span class="nv">N</span><span class="p">]</span> <span class="nv">theta</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nv">n</span> <span class="kr">in</span> <span class="mi">1</span><span class="o">:</span><span class="nv">N</span><span class="p">){</span>
    <span class="nv">theta</span><span class="p">[</span><span class="nv">n</span><span class="p">]</span> <span class="o">=</span> <span class="nv">Intercept</span> <span class="o">+</span> <span class="nv">driver_effect</span><span class="p">[</span><span class="nv">driver</span><span class="p">[</span><span class="nv">n</span><span class="p">]]</span>  <span class="o">*</span> <span class="nv">grid</span><span class="p">[</span><span class="nv">n</span><span class="p">]</span> <span class="o">+</span>
                       <span class="nv">team_effect</span><span class="p">[</span><span class="nv">team</span><span class="p">[</span><span class="nv">n</span><span class="p">]]</span> <span class="o">+</span> <span class="nv">engine_effect</span><span class="p">[</span><span class="nv">engine</span><span class="p">[</span><span class="nv">n</span><span class="p">]];</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nn">model</span> <span class="p">{</span>
  <span class="c1">// Priors</span>
  <span class="nv">Intercept</span> <span class="o">~</span> <span class="nb">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nv">driver_effect</span> <span class="o">~</span> <span class="nb">normal</span><span class="p">(</span><span class="nv">driver_mu</span><span class="p">,</span> <span class="nv">driver_sd</span><span class="p">);</span>
  <span class="nv">team_effect</span> <span class="o">~</span> <span class="nb">normal</span><span class="p">(</span><span class="nv">team_mu</span><span class="p">,</span> <span class="nv">team_sd</span><span class="p">);</span>
  <span class="nv">engine_effect</span> <span class="o">~</span> <span class="nb">normal</span><span class="p">(</span><span class="nv">engine_mu</span><span class="p">,</span> <span class="nv">engine_sd</span><span class="p">);</span>
  <span class="nv">driver_mu</span> <span class="o">~</span> <span class="nb">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nv">driver_sd</span> <span class="o">~</span> <span class="nb">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nv">team_mu</span> <span class="o">~</span> <span class="nb">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nv">team_sd</span> <span class="o">~</span> <span class="nb">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nv">engine_mu</span> <span class="o">~</span> <span class="nb">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nv">engine_sd</span> <span class="o">~</span> <span class="nb">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

  <span class="c1">// Likelihood</span>
  <span class="nv">finished</span> <span class="o">~</span> <span class="nb">bernoulli_logit</span><span class="p">(</span><span class="nv">theta</span><span class="p">);</span>
<span class="p">}</span>

<span class="nn">generated quantities</span> <span class="p">{</span>
  <span class="kt">real</span> <span class="nv">y_rep</span><span class="p">[</span><span class="nv">N</span><span class="p">];</span>
  <span class="kt">vector</span><span class="p">[</span><span class="nv">N</span><span class="p">]</span> <span class="nv">log_lik</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nv">n</span> <span class="kr">in</span> <span class="mi">1</span><span class="o">:</span><span class="nv">N</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">y_rep</span><span class="p">[</span><span class="nv">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bernoulli_logit_rng</span><span class="p">(</span><span class="nv">theta</span><span class="p">[</span><span class="nv">n</span><span class="p">]);</span>
    
    <span class="nv">log_lik</span><span class="p">[</span><span class="nv">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bernoulli_logit_lpmf</span><span class="p">(</span><span class="nv">finished</span><span class="p">[</span><span class="nv">n</span><span class="p">]</span> <span class="p">|</span> <span class="nv">theta</span><span class="p">[</span><span class="nv">n</span><span class="p">]);</span>
  <span class="p">}</span>
  
<span class="p">}</span>
</code></pre></div></div>
<p>Now that we have the code for both our models we can run them from R.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_total</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">data_model</span><span class="p">[,</span><span class="m">1</span><span class="p">])</span><span class="w">
</span><span class="n">quali_pos</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">Pos</span><span class="w">
</span><span class="n">kph_cent</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">Kph</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">data_model</span><span class="o">$</span><span class="n">Kph</span><span class="p">)</span><span class="w">
</span><span class="n">engine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">new_engine</span><span class="w">
</span><span class="n">wdc_points</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">wdc_points_shift</span><span class="w">
</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">points</span><span class="w">

</span><span class="n">covariates</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">n_total</span><span class="p">),</span><span class="w"> </span><span class="n">quali_pos</span><span class="p">,</span><span class="w"> </span><span class="n">kph_cent</span><span class="p">,</span><span class="w"> </span><span class="n">model.matrix</span><span class="p">(</span><span class="o">~</span><span class="n">engine</span><span class="p">)[,</span><span class="m">-1</span><span class="p">],</span><span class="w"> </span><span class="n">wdc_points</span><span class="p">)</span><span class="w">
</span><span class="n">stan_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="w">
  </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_total</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">dim</span><span class="p">(</span><span class="n">covariates</span><span class="p">)[</span><span class="m">2</span><span class="p">],</span><span class="w"> 
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">covariates</span><span class="p">,</span><span class="w">
  </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w">
</span><span class="p">)</span><span class="w">
</span><span class="n">simple_mod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stan</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stan_data</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">here</span><span class="p">(</span><span class="s2">"model1.stan"</span><span class="p">),</span><span class="w">
                   </span><span class="n">chains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="p">,</span><span class="w"> </span><span class="n">cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>We can analyzed the sampling behavior of the model using traceplots and pair plots. In figure 8 below we can see that the chains are mixing correctly for all coefficients. Pairs plots were also analyzed (see appendix) and no strange behavior was found.</p>

<p>The estimated mean coefficients for each variable are shown below in the odds scale, with their respective 95% CI’s (credible intervals). We can see that the qualifying position, which is also the starting position for the race, has a very significant impact in the odds of scoring points. The lower the starting position the higher the odds of scoring points, which makes sense. For the engine variable the model is taking Alfa Romeo’s engine as a baseline. Most engine manufacturers have negative mean estimated coefficients, however, their estimated errors are very large and include 1. We can see that a driver with a Ferrari engine has almost twice the odds of scoring points than one with an Alfa Romeo engine. This is surprising as many smaller teams used Ferrari power units, however, Scuderia Ferrari as a team had highly dominant years in this time period. We can see that the current WDC points had little to no impact in the odds of scoring points in a given race, this might be due to the variability of championship fights from year to year, in some years one driver is very dominant so he will have a lot of points accumulated, while in others the field is much closer togther, resulting in all drivers having less points.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">colnames</span><span class="p">(</span><span class="n">covariates</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Intercept"</span><span class="w"> 
</span><span class="n">variables</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">colnames</span><span class="p">(</span><span class="n">covariates</span><span class="p">),</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colnames</span><span class="p">(</span><span class="n">covariates</span><span class="p">))</span><span class="w">
</span><span class="n">as_tibble</span><span class="p">(</span><span class="n">summary</span><span class="p">(</span><span class="n">simple_mod</span><span class="p">)</span><span class="o">$</span><span class="n">summary</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">16</span><span class="p">,</span><span class="nf">c</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">)]</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nf">exp</span><span class="p">()</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">covariate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">variables</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">covariate</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_y_discrete</span><span class="p">(</span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rev</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_pointinterval</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">`2.5%`</span><span class="p">,</span><span class="w"> </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">`97.5%`</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.85</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Mean coefficient estimates"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Estimated coefficients from the fixed effects model"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p><img src="/img/wave-equation/hook-wave.png" title="\Large Weights-and-strings" width="100%" /></p>

<h2 id="hierarchical-model">Hierarchical model</h2>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_total</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">data_model</span><span class="p">[,</span><span class="m">1</span><span class="p">])</span><span class="w">
</span><span class="n">n_years</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">years</span><span class="p">)</span><span class="w">
</span><span class="n">n_drivers</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">data_model</span><span class="o">$</span><span class="n">Driver</span><span class="p">))</span><span class="w">
</span><span class="n">n_races</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">data_model</span><span class="o">$</span><span class="n">Date</span><span class="p">))</span><span class="w">
</span><span class="n">race_index</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">race_index</span><span class="w">

</span><span class="n">stan_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="w">
  </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_total</span><span class="p">,</span><span class="w"> 
  </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_drivers</span><span class="p">,</span><span class="w"> 
  </span><span class="nb">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">data_model</span><span class="o">$</span><span class="n">team_index</span><span class="p">)),</span><span class="w"> 
  </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">data_model</span><span class="o">$</span><span class="n">engine_index</span><span class="p">)),</span><span class="w"> 
  </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_years</span><span class="p">,</span><span class="w">
  </span><span class="n">race</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">race_index</span><span class="p">,</span><span class="w"> </span><span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">driver_index</span><span class="p">,</span><span class="w">
  </span><span class="n">team</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">team_index</span><span class="p">,</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">engine_index</span><span class="p">,</span><span class="w"> 
  </span><span class="n">grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">Pos</span><span class="p">,</span><span class="w"> </span><span class="n">num_races</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">exp</span><span class="p">,</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">points</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="n">model_hierar_1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stan</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">here</span><span class="p">(</span><span class="s2">"Project/stan_code/model1.stan"</span><span class="p">),</span><span class="w"> 
                      </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stan_data</span><span class="p">,</span><span class="w"> </span><span class="n">chains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5000</span><span class="p">,</span><span class="w"> </span><span class="n">cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>The sampling was ran for 5000 iterations and 4 chains, up to the writing of this report there are still divergent chains for some of the variables, however, this model is still relevant because is the one that yielded the best results, and it’s also the one achieving the largest elpd (see next subsection). We can take a sample of the parameters and look at their traceplots.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">traceplot</span><span class="p">(</span><span class="n">model_hierar_1</span><span class="p">,</span><span class="w"> </span><span class="n">pars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"driver_effect["</span><span class="p">,</span><span class="n">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">140</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">),</span><span class="s2">"]"</span><span class="p">),</span><span class="w">
                                   </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"engine_effect["</span><span class="p">,</span><span class="n">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">),</span><span class="s2">"]"</span><span class="p">),</span><span class="w"> 
                                   </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"team_effect["</span><span class="p">,</span><span class="n">sample</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">),</span><span class="s2">"]"</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>
<p>As we can see the chains are mixing, although these could be improved further. Joint distribution of the parameters look good, with no apparent divergent behavior.</p>

<h2 id="evaluation-and-comparison">Evaluation and comparison</h2>
<p>Posterior predictive checks were made for both models in order to compare how well they are fitting the data. The proportion of drivers who finished in the points starting from a grid position of tenth or lower was chosen as a test statistic. In Figure 5 we can see that the distributions of the models look almost exactly the same, with the true proportion centered around the mean of the distributions. This means that both models are good fit for the data, and that they can predict the outcome variable of interest successfully.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#| label: ppc-1</span><span class="w">
</span><span class="c1">#| fig-cap: "Distribution of the proportions of drivers that score points starting from 10th or lower."</span><span class="w">
</span><span class="n">group_stat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="p">){</span><span class="w">
</span><span class="n">grid_position</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="n">true_value</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">data_model</span><span class="o">$</span><span class="n">points</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">Pos</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">grid_position</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> 
              </span><span class="nf">sum</span><span class="p">(</span><span class="n">data_model</span><span class="o">$</span><span class="n">Pos</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">grid_position</span><span class="p">)</span><span class="w">

</span><span class="n">yrep</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">extract</span><span class="p">(</span><span class="n">model</span><span class="p">)[[</span><span class="s2">"y_rep"</span><span class="p">]]</span><span class="w">
</span><span class="c1">#yrep_samp &lt;- yrep#[sample(nrow(yrep), 1000), ] #optional for sampling</span><span class="w">

</span><span class="n">p1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">yrep</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">quali_pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">Pos</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">across</span><span class="p">(</span><span class="o">-</span><span class="n">quali_pos</span><span class="p">,</span><span class="w"> 
                </span><span class="o">~</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">.x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">quali_pos</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">grid_position</span><span class="p">)</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">quali_pos</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">grid_position</span><span class="p">)))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">sample_n</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">pivot_longer</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">quali_pos</span><span class="p">,</span><span class="w"> </span><span class="n">names_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"itereation"</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">..density..</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"lightblue"</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="n">bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">40</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_vline</span><span class="p">(</span><span class="w">
    </span><span class="n">xintercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">true_value</span><span class="p">,</span><span class="w">
    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Estimates"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">0.03</span><span class="p">,</span><span class="w"> </span><span class="m">0.12</span><span class="p">,</span><span class="w"> </span><span class="m">0.03</span><span class="p">),</span><span class="w"> </span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.02</span><span class="p">,</span><span class="w"> </span><span class="m">0.13</span><span class="p">))</span><span class="w"> 
</span><span class="nf">return</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">p1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">group_stat</span><span class="p">(</span><span class="n">simple_mod</span><span class="p">,</span><span class="w"> </span><span class="s2">"Fixed Effects"</span><span class="p">)</span><span class="w">
</span><span class="n">p2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">group_stat</span><span class="p">(</span><span class="n">model_hierar_1</span><span class="p">,</span><span class="w"> </span><span class="s2">"Hierarchical Model"</span><span class="p">)</span><span class="w">
</span><span class="n">grid.arrange</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The models had very similar $\text{elpd}_{\text{loo}}$, there was a difference between them of 2, with a standard error of 3.2, with the hierarchical model having the higher value. Given that the difference is smaller than the standard error, we can’t infer with enough statistical confidence that the second model is better. The fixed effects model had all Pareto parameters $k$ lower than 0.5, while the hierarchical model had 22 $k$ parameters higher than 0.5, which accounts for 2.5%.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">loo1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">loo</span><span class="p">(</span><span class="n">simple_mod</span><span class="p">)</span><span class="w">
</span><span class="n">loo2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">loo</span><span class="p">(</span><span class="n">model_hierar_1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>In the figure below we can see that both models are performing very similar according to the $\text{elpd}_{\text{loo}}$ criterion.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#| label: elpd_loo</span><span class="w">
</span><span class="c1">#| fig-cap: "Scatter plot of ELPD values of both models."</span><span class="w">
</span><span class="n">elpd_models</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
</span><span class="n">data.frame</span><span class="p">(</span><span class="n">elpd_mod1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loo1</span><span class="o">$</span><span class="n">pointwise</span><span class="p">[,</span><span class="m">1</span><span class="p">],</span><span class="w">
           </span><span class="n">elpd_mod2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loo2</span><span class="o">$</span><span class="n">pointwise</span><span class="p">[,</span><span class="m">1</span><span class="p">],</span><span class="w">
           </span><span class="n">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">data_model</span><span class="o">$</span><span class="n">points</span><span class="p">),</span><span class="w">
           </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data_model</span><span class="o">$</span><span class="n">Pos</span><span class="p">)</span><span class="w"> 
</span><span class="n">p1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">elpd_models</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elpd_mod1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">elpd_mod2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_point</span><span class="p">(</span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_abline</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
 </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"ELPD values for both models"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.06</span><span class="p">,</span><span class="m">0.85</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"Simple Logistic Regression"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">ylab</span><span class="p">(</span><span class="s2">"Hierarchical Model"</span><span class="p">)</span><span class="w">
</span><span class="n">p1</span><span class="w">
</span></code></pre></div></div>
<p>The receiver operating characteristic (ROC) curve was plotted for both models (see figure 7), although running the models with less iterations showed a significantly higher performance for the hierarchical model, for this final version they are very similar. The area under the curve (auc) was found to be slightly higher for the hierarchical model with 0.8783 than the fixed effects model with 0.8671. Overall this are very good results.</p>
<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#| label: roc</span><span class="w">
</span><span class="c1">#| fig-cap: "The ROC curve shows a very similar performance between the two models."</span><span class="w">
</span><span class="n">inv.logit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="nf">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">+</span><span class="nf">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">false_positive_rate</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span><span class="w"> </span><span class="n">true</span><span class="p">){</span><span class="w">
    </span><span class="n">fp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">true</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">prediction</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">prediction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
    </span><span class="n">tn</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">true</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">prediction</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">true</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">fp</span><span class="o">/</span><span class="p">(</span><span class="n">tn</span><span class="o">+</span><span class="n">fp</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">true_positive_rate</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span><span class="w"> </span><span class="n">true</span><span class="p">){</span><span class="w">
  </span><span class="n">tp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">true</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">prediction</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">prediction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
  </span><span class="n">fn</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">true</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">prediction</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">prediction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">tp</span><span class="o">/</span><span class="p">(</span><span class="n">tp</span><span class="o">+</span><span class="n">fn</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">roc_curve_tibble</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">true</span><span class="p">,</span><span class="w"> </span><span class="n">pred_probs</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">){</span><span class="w">
  </span><span class="n">thresholds</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0.01</span><span class="p">)</span><span class="w">
  </span><span class="n">y_pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="n">ifelse</span><span class="p">(</span><span class="n">pred_probs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">
  </span><span class="n">tpr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">thresholds</span><span class="p">),</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="n">true_positive_rate</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[,</span><span class="n">x</span><span class="p">],</span><span class="w"> </span><span class="n">true</span><span class="p">))</span><span class="w">
  </span><span class="n">fpr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">thresholds</span><span class="p">),</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="n">false_positive_rate</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[,</span><span class="n">x</span><span class="p">],</span><span class="w"> </span><span class="n">true</span><span class="p">))</span><span class="w">  
  </span><span class="n">model_name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">thresholds</span><span class="p">))</span><span class="w">
  
  </span><span class="nf">return</span><span class="p">(</span><span class="n">as_tibble</span><span class="p">(</span><span class="n">cbind</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span><span class="w"> </span><span class="n">fpr</span><span class="p">,</span><span class="w"> </span><span class="n">tpr</span><span class="p">)))</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">predicted_probabilities</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">model</span><span class="p">){</span><span class="w">
  </span><span class="n">thetas</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">summary</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">$</span><span class="n">summary</span><span class="p">[</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"theta["</span><span class="p">,</span><span class="m">1</span><span class="o">:</span><span class="n">n_total</span><span class="p">,</span><span class="s2">"]"</span><span class="p">),</span><span class="m">1</span><span class="p">]</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">inv.logit</span><span class="p">(</span><span class="n">thetas</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">roc_tibble_1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">roc_curve_tibble</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">predicted_probabilities</span><span class="p">(</span><span class="n">simple_mod</span><span class="p">),</span><span class="w"> 
                                 </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Fixed effects"</span><span class="p">)</span><span class="w">
</span><span class="n">roc_tibble_2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">roc_curve_tibble</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">predicted_probabilities</span><span class="p">(</span><span class="n">model_hierar_1</span><span class="p">),</span><span class="w"> 
                                 </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Hierarchical model"</span><span class="p">)</span><span class="w">

</span><span class="n">rbind</span><span class="p">(</span><span class="n">roc_tibble_1</span><span class="p">,</span><span class="w"> </span><span class="n">roc_tibble_2</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">fpr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">fpr</span><span class="p">),</span><span class="w"> </span><span class="n">tpr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">tpr</span><span class="p">))</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> 
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span><span class="w"> </span><span class="n">tpr</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_name</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">linewidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.85</span><span class="p">,</span><span class="m">0.25</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_abline</span><span class="p">(</span><span class="n">linetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">scale_color_discrete</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">"False Positive Rate"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s2">"True Positive Rate"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"ROC curve for different model fits"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
:ET